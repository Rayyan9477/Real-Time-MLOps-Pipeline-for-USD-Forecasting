name: Model Training and CML Report

on:
  pull_request:
    branches: [main]

jobs:
  train-and-compare:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Load environment variables
      run: |
        echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_ENV
        echo "DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_URI=https://dagshub.com/${{ secrets.DAGSHUB_USERNAME }}/Real-Time-MLOps-Pipeline-for-USD-Forecasting.mlflow" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_USERNAME=${{ secrets.DAGSHUB_USERNAME }}" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_PASSWORD=${{ secrets.DAGSHUB_TOKEN }}" >> $GITHUB_ENV
        echo "TWELVE_DATA_API_KEY=${{ secrets.TWELVE_DATA_API_KEY }}" >> $GITHUB_ENV
        echo "DAGSHUB_USERNAME=${{ secrets.DAGSHUB_USERNAME }}" >> $GITHUB_ENV
        echo "DAGSHUB_TOKEN=${{ secrets.DAGSHUB_TOKEN }}" >> $GITHUB_ENV

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Setup DVC
      uses: iterative/setup-dvc@v1

    - name: Configure DVC for DagsHub
      env:
        DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        if dvc remote list | awk '{print $1}' | grep -qx 'dagshub'; then
          echo "DVC remote 'dagshub' already exists; updating auth"
        else
          dvc remote add -d dagshub "https://dagshub.com/$DAGSHUB_USERNAME/Real-Time-MLOps-Pipeline-for-USD-Forecasting.dvc"
        fi
        dvc remote modify dagshub --local auth basic
        dvc remote modify dagshub --local user "$DAGSHUB_USERNAME"
        dvc remote modify dagshub --local password "$DAGSHUB_TOKEN"

    - name: Pull latest data with DVC
      continue-on-error: true
      run: |
        dvc pull || echo "DVC pull failed, continuing with local data"

    - name: Setup CML
      uses: iterative/setup-cml@v1

    - name: Train model
      continue-on-error: true
      run: |
        python src/models/trainer.py --experiment "ci_cd_testing" || echo "Model training failed, continuing"

    - name: Generate metrics report
      run: |
        python -c "
        try:
            import mlflow
            import os

            mlflow.set_tracking_uri(os.getenv('MLFLOW_TRACKING_URI'))
            client = mlflow.tracking.MlflowClient()

            # Get latest run from test branch
            experiment = client.get_experiment_by_name('ci_cd_testing')
            if experiment:
                runs = client.search_runs(experiment.experiment_id, order_by=['start_time DESC'], max_results=1)

                if runs:
                    latest_run = runs[0]
                    metrics = latest_run.data.metrics

                    # Write metrics to file
                    with open('metrics.txt', 'w') as f:
                        f.write('## Model Performance Metrics\n\n')
                        f.write(f'**RMSE**: {metrics.get(\"rmse\", \"N/A\"):.6f}\n')
                        f.write(f'**MAE**: {metrics.get(\"mae\", \"N/A\"):.6f}\n')
                        f.write(f'**R²**: {metrics.get(\"r2\", \"N/A\"):.6f}\n')
                        f.write(f'**MAPE**: {metrics.get(\"mape\", \"N/A\"):.2f}%\n\n')
                        f.write(f'**Drift Ratio**: {metrics.get(\"drift_ratio\", \"N/A\"):.2%}\n')
                        f.write(f'**Drifted Features**: {int(metrics.get(\"num_drifted_features\", 0))}/{int(metrics.get(\"total_features\", 0))}\n')
                else:
                    with open('metrics.txt', 'w') as f:
                        f.write('## Model Performance Metrics\n\n')
                        f.write('No runs found in ci_cd_testing experiment\n')
            else:
                with open('metrics.txt', 'w') as f:
                    f.write('## Model Performance Metrics\n\n')
                    f.write('ci_cd_testing experiment not found\n')
        except Exception as e:
            with open('metrics.txt', 'w') as f:
                f.write('## Model Performance Metrics\n\n')
                f.write(f'Error generating metrics: {str(e)}\n')
        "

    - name: Create CML report
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Add metrics to report
        cat metrics.txt >> report.md

        # Add comparison note
        echo "" >> report.md
        echo "---" >> report.md
        echo "### Recommendation" >> report.md
        echo "✓ Review metrics above before merging to main branch" >> report.md
        echo "✓ Ensure RMSE has not degraded by more than 10%" >> report.md
        echo "✓ Check drift ratio is within acceptable limits" >> report.md

        # Post comment with CML
        cml comment create report.md
